Metadata-Version: 2.4
Name: dpw-calculator
Version: 1.0.0
Summary: Die per wafer calculator
Author: PyEDA Team
Requires-Python: >=3.9
Description-Content-Type: text/markdown
Requires-Dist: PyYAML>=6.0
Requires-Dist: Jinja2>=3.1
Provides-Extra: dev
Requires-Dist: pytest>=7.0; extra == "dev"
Provides-Extra: feishu
Requires-Dist: fastapi>=0.110; extra == "feishu"
Requires-Dist: uvicorn>=0.23; extra == "feishu"
Requires-Dist: requests>=2.31; extra == "feishu"

# dpw

Die per wafer calculator（DPW 计算器）。

## 安装（含测试）

需要 `python3`（建议 3.9+）。

```bash
python3 -m venv .venv
source .venv/bin/activate
python -m pip install -U pip
python -m pip install -e ".[dev]"
```

运行测试：

```bash
python -m pytest
```

## VPS 上跑

在 VPS 上按同样步骤创建 venv 并安装，然后直接 `pytest` 即可。

## VPS 一键部署（推荐）

在你本机执行一条命令即可完成 VPS 上的 clone/pull + venv + 安装（可选跑测试）：

```bash
ssh user@vps 'bash -s -- --dir /opt/dpw --repo <YOUR_GIT_URL> --branch main --run-tests' < scripts/deploy_vps.sh
```

部署完成后：

- Python 解释器：`/opt/dpw/.venv/bin/python`
- 更新：重复执行同一条命令（会自动 pull 并重装）

## 飞书应用机器人（事件回调）调用 dpw（纯文本命令、无加密/校验）

1) 在飞书开放平台应用里订阅事件 `im.message.receive_v1`，回调地址指向你的 VPS：
   - `https://<your-domain>/feishu/callback`
2) 在 VPS 安装依赖并启动回调服务：

```bash
cd /opt/dpw
/opt/dpw/.venv/bin/python -m pip install -e ".[feishu]"
export FEISHU_APP_ID="xxx"
export FEISHU_APP_SECRET="yyy"
/opt/dpw/.venv/bin/python -m uvicorn scripts.feishu_dpw_bot:app --host 0.0.0.0 --port 8000
```

3) 飞书里发纯文本命令：

```text
dpw 200 1000x2000 scribe=50x50 edge=3 yield=80 method=corner notch=none
```

参数说明：
- `wafer_mm`：晶圆直径（mm）
- `die_x_um x die_y_um`：die 尺寸（um）
- `scribe=AxB`：scribe（um，可选）
- `edge=`：edge exclusion（mm，可选）
- `yield=`：0-100（可选）
- `method=`：`center|corner|area|strict`（可选）
- `notch=`：`none|v90|flat`（可选）
- `notch_depth=`：mm（可选）

## clawdbot 调用 dpw（推荐：直接执行命令回传 stdout）

VPS 上安装完成后，用固定解释器直接跑模块：

```bash
/opt/dpw/.venv/bin/python -m dpw 200 1000x2000 scribe=50x50 edge=3 yield=80 method=corner notch=none
```

如果 clawdbot 需要结构化结果，追加 `--json`：

```bash
/opt/dpw/.venv/bin/python -m dpw --json 200 1000x2000 scribe=50x50 edge=3 yield=80 method=corner notch=none
```

## 飞书→VPS→调用 dpw 的测试建议

如果你的飞书 bot 是通过 `subprocess` 去调用远程 VPS 上的 `dpw`（或封装后的脚本），建议把“命令拼接/参数校验/超时/错误回传”抽成独立函数，然后：

- 单元测试：mock `subprocess.run`，覆盖成功/超时/非 0 退出码/输出过长等分支
- 集成测试：在 VPS 上跑一条真实命令（固定参数），断言返回 JSON 或关键字段
